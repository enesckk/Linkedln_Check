// Prisma Schema
// PostgreSQL veritabanı için 7 model tanımı
// LinkedIn Analyzer Web App - Clean & Scalable Database Schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/**
 * User Model
 * NextAuth ile entegre kullanıcı modeli
 * OAuth kullanıcıları için password opsiyoneldir
 */
model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  image         String?
  password      String?   // OAuth varsa opsiyonel
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // NextAuth Relations
  accounts      Account[]
  sessions      Session[]
  
  // App Relations
  reports       Report[]
  
  @@map("users")
}

/**
 * Account Model
 * NextAuth OAuth account bilgileri
 */
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

/**
 * Session Model
 * NextAuth session bilgileri
 */
model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

/**
 * VerificationToken Model
 * NextAuth email verification token'ları
 */
model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

/**
 * Report Model
 * Her analiz bir Report kaydı üretir
 * Tüm analiz sürecinin ana kaydı
 */
model Report {
  id          String   @id @default(cuid())
  userId      String
  linkedinUrl String
  status      String   @default("processing") // processing, completed, failed
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  user            User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  pdfRawData      PdfRawData?
  scrapedRawData  ScrapedRawData?
  mergedData      MergedData?
  ruleResults     RuleResults?
  aiFeedback      AiFeedback?
  
  @@map("reports")
}

/**
 * PdfRawData Model
 * PDF'den parse edilen ham veri
 * LinkedIn PDF Export'tan çıkarılan structured data
 */
model PdfRawData {
  id             String   @id @default(cuid())
  reportId       String   @unique
  headline       String?
  about          String?
  experiences    Json?    // Array of experience objects
  education      Json?    // Array of education objects
  skills         Json?    // Array of skills
  certifications Json?    // Array of certification objects
  languages      Json?    // Array of language objects
  rawText        String?  // PDF'den alınan ham text
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  // Relations
  report Report @relation(fields: [reportId], references: [id], onDelete: Cascade)
  
  @@map("pdf_raw_data")
}

/**
 * ScrapedRawData Model
 * Scraping microservice'den gelen ham veri
 * Playwright ile scrape edilen LinkedIn profil verileri
 */
model ScrapedRawData {
  id             String   @id @default(cuid())
  reportId       String   @unique
  bannerUrl      String?
  profilePhoto   String?
  photoResolution String?
  connections    Int?
  featured       Json?    // Array of featured items
  endorsements   Json?    // Array of endorsement objects
  activity       Json?    // Array of activity objects
  recommendations Json?   // Array of recommendation objects
  media          Json?    // Array of media attachments
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  // Relations
  report Report @relation(fields: [reportId], references: [id], onDelete: Cascade)
  
  @@map("scraped_raw_data")
}

/**
 * MergedData Model
 * PDF + Scraped data'nın birleştirilmiş hali (Data Fusion)
 * PDF öncelikli, eksik alanlar scraping'den doldurulur
 */
model MergedData {
  id             String   @id @default(cuid())
  reportId       String   @unique
  headline       String?
  about          String?
  skills         Json?    // Array of skills
  education      Json?    // Array of education objects
  certifications Json?    // Array of certification objects
  languages      Json?    // Array of language objects
  connections    Int?
  bannerUrl      String?
  featured       Json?    // Array of featured items
  endorsedSkills Json?    // Array of endorsed skills with counts
  media          Json?    // Array of media attachments
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  // Relations
  report Report @relation(fields: [reportId], references: [id], onDelete: Cascade)
  
  @@map("merged_data")
}

/**
 * RuleResults Model
 * Rule engine'in checklist kontrol sonuçları
 * Her kural için passed/failed durumu ve mesaj içerir
 */
model RuleResults {
  id        String   @id @default(cuid())
  reportId  String   @unique
  results   Json     // Rule check results (headline, about, skills, banner, connections, education, certifications)
  score     Int?     // Rule-based score (0-100)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  report Report @relation(fields: [reportId], references: [id], onDelete: Cascade)
  
  @@map("rule_results")
}

/**
 * AiFeedback Model
 * AI değerlendirme sonuçları
 * Gemini veya GPT API'den gelen feedback ve öneriler
 */
model AiFeedback {
  id                String   @id @default(cuid())
  reportId          String   @unique
  headlineSuggestion String?
  aboutSuggestion   String?
  overallFeedback   String?
  aiScore           Int?     // AI tarafından verilen final skor (0-100)
  insights          Json?    // Additional AI insights and missing points
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  // Relations
  report Report @relation(fields: [reportId], references: [id], onDelete: Cascade)
  
  @@map("ai_feedback")
}

